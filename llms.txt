# mpaviewer

[mpaviewer](https://mpaviewer.dbca.wa.gov.au/) is a dashboard of marine
monitoring data for DBCA staff.

## Architecture

- Data is loaded from a locally saved `.rds` file, or freshly loaded
  from Google Drive or the DBCA data catalogue (and then saved as
  `.rds`). The locally saved file lives on a persistent volume.

## Data

The dashboard runs off a single `mpa_data.rds` R save file which is
produced from a range of source data files (CSV, TXT, SHP).

Archived on the DBCA data catalogue as dataset
[mpaviewer](https://data.dbca.wa.gov.au/dataset/mpaviewer) are: \* A
link to a Google Drive folder which contains a copy of source data files
in the folder/file/data structure expected by
[`mpaviewer::generate_data()`](https://dbca-wa.github.io/mpaviewer/reference/generate_data.md).
\* Links to the deployed dashboard and this GitHub code repository \*
The mpaviewer data file `mpa_data.rds` at a specific resource ID
expected by
[`mpaviewer::download_data()`](https://dbca-wa.github.io/mpaviewer/reference/download_data.md).

### Update source data

Data owners can update the Google Drive folder with new data.

### Generate dashboard data

Whenever the source data was updated, an analyst must download the
contents of the Google Drive folder “mpaviewer” into the directory
`inst/data` of a local clone of the mpaviewer codebase and run
[`mpaviewer::generate_data()`](https://dbca-wa.github.io/mpaviewer/reference/generate_data.md),
then upload the data file `mpa_data.rds` to the DBCA data catalogue.

### Update the dashboard with new data

A [Docker container for
ETL](https://github.com/dbca-wa/mpaviewer/pkgs/container/mpaviewer_cron)
periodically executes a script to download source data and process it
into the application data.

Until the source data files are all available from the DBCA Data
Catalogue, the container simply downloads the pre-processed data file
`mpa_data.rds` from the DBCA data catalogue.

## Development

`mpaviewer` is an RShiny app using [Shiny
modules](https://shiny.rstudio.com/articles/modules.html), developed
using [`golem`](https://mastering-shiny.org/scaling-modules.html).

The commands to develop new functionality are in `dev/02_dev.R`.

- Create a GH issue for each task, keep it as small and self-contained
  as possible.
- Work on one issue at a time.
- Once R CMD Check passes and all build errors and warnings are
  addressed, commit changes.
- Write descriptive and well-formed commit messages and reference the GH
  issue.
- Push and see whether the R CMD Check GH action passes.
- Bonus points: Build and run the Docker image locally. If that’s not an
  option, at least make sure that any new package dependencies are added
  to the Dockerfile.

## Release

Once app and Docker image work, create a new version, tag, and push the
tag.

``` r
styler::style_pkg()
spelling::spell_check_package()
spelling::update_wordlist()

# Code and docs tested, working, committed
usethis::use_version(which="patch")
usethis::use_version(which="minor")
usethis::use_version(which="major")
usethis::edit_file("NEWS.md")

# Document to load new package version. Git commit, tag, and push.
devtools::document()
v <- packageVersion("mpaviewer")
system(glue::glue("git tag -a v{v} -m 'v{v}' && git push && git push --tags"))
```

## Deployment

GitHub Actions are configured to build a new Docker image for every tag
starting with “v”, such as “v1.0.0”. The images are pushed to the GitHub
container registry `ghcr.io`. The DBCA maintainer of `mpaviewer` then
updates the tag number (e.g. `1.0.0`) in the image run by Kubernetes,
which will trigger a hot reload of the image.

The commands to deploy a new version are in `dev/03_deploy.R`.

# Package index

## All functions

- [`add_legend_sr()`](https://dbca-wa.github.io/mpaviewer/reference/add_legend_sr.md)
  : Add a legend to a Leaflet map
- [`add_legend_ta()`](https://dbca-wa.github.io/mpaviewer/reference/add_legend_ta.md)
  : Add a legend to a Leaflet map
- [`download_data()`](https://dbca-wa.github.io/mpaviewer/reference/download_data.md)
  : Download the application data file mpa_data.rds from CKAN
- [`download_source_data()`](https://dbca-wa.github.io/mpaviewer/reference/download_source_data.md)
  : Download source data files from CKAN to the local data directory
- [`generate_data()`](https://dbca-wa.github.io/mpaviewer/reference/generate_data.md)
  : Generate one data object to use in server.R
- [`generate_plots()`](https://dbca-wa.github.io/mpaviewer/reference/generate_plots.md)
  : Generate plots to display in the dashboard
- [`ggplot_mpatheme()`](https://dbca-wa.github.io/mpaviewer/reference/ggplot_mpatheme.md)
  : A custom GGplot2 theme for mpaviewer
- [`googledrive_download_data()`](https://dbca-wa.github.io/mpaviewer/reference/googledrive_download_data.md)
  : Download the application data file mpa_data.rds from CKAN
- [`leaflet_basemap()`](https://dbca-wa.github.io/mpaviewer/reference/leaflet_basemap.md)
  : Create a Leaflet basemap for Western Australia
- [`make_docker()`](https://dbca-wa.github.io/mpaviewer/reference/make_docker.md)
  : Build and push Docker images
- [`print(`*`<mpa_data>`*`)`](https://dbca-wa.github.io/mpaviewer/reference/print.mpa_data.md)
  : S3 print method for 'mpa_data'.
- [`read_dbca_files_csv()`](https://dbca-wa.github.io/mpaviewer/reference/read_dbca_files_csv.md)
  : Read DBCA CSV files
- [`read_dbca_files_txt()`](https://dbca-wa.github.io/mpaviewer/reference/read_dbca_files_txt.md)
  : Read DBCA TXT files
- [`run_app()`](https://dbca-wa.github.io/mpaviewer/reference/run_app.md)
  : Run the Shiny Application
- [`se()`](https://dbca-wa.github.io/mpaviewer/reference/se.md) :
  Calculate standard error
- [`se.max()`](https://dbca-wa.github.io/mpaviewer/reference/se.max.md)
  : Calculate standard error maximum
- [`se.min()`](https://dbca-wa.github.io/mpaviewer/reference/se.min.md)
  : Calculate standard error minimum

# Articles

### All vignettes

- [mpaviewer](https://dbca-wa.github.io/mpaviewer/articles/mpaviewer.md):
